# Javascript性能优化

#### 性能优化介绍

- 性能优化是不可避免的
- 哪些内容可以看做是性能优化
- 无处不在的前端性能优化

---

#### 内存管理

##### 内存管理介绍

- 内存：由可读写单元组成，表示一片可操作空间
- 管理： 人为的去操作一片空间的申请、使用和释放
- 内存管理：开发者主动申请空间、使用空间、释放空间
- 管理流程：申请—使用—释放

##### Javascript中的内存管理

- 申请内存空间
- 使用内存空间
- 释放内存空间

---

#### 垃圾回收

##### Javascript中的垃圾

- Javascrip中的内存管理是自动的
- 对象不再被引用时是垃圾
- 对象不能从根上访问到时是垃圾

##### Javascript中的可达对象

- 可以访问到的对象就是可达对象（引用、作用域链）
- 可达的标准就是从根出发是否能够被找到
- Javascript中的根就可以理解为是全局变量对象

##### Javascript中的引用和可达

---

#### GC算法介绍

##### GC定义与作用

- GC就是垃圾回收机制的简写
- GC可以找到内存中的垃圾、并释放和回收空间

##### GC里的垃圾是什么

- 程序中不再需要使用对象

##### GC算法是什么

- GC是一种机制，垃圾回收器完成具体的工作
- 工作的内容就是查找垃圾释放空间、回收空间
- 算法就是工作时查找和回收所遵循的规则

##### 常见GC算法

- 引用计数
- 标记清除
- 标记整理
- 分代回收

##### 引用计数算法实现原理

###### 引用计数算法

- 核心思想：设置引用数，判断当前引用数是否为0
- 引用计数器
- 引用关系改变时修改引用数字
- 引用数字为0时立刻回收

###### 引用计数算法优缺点

*优点*

- 发现垃圾时立即回收
- 最大限度减少程序暂停

*缺点*

- 无法回收循环引用的对象
- 时间开销大

##### 标记清除算法实现原理

###### 标记清除算法

- 核心思想：分标记和清除二个阶段完成
- 遍历所有对象找标记活动对象
- 遍历所有对象清除没有标记对象
- 回收相应的空间

###### 标记清除算法优缺点

*优点*

- 解决对象循环引用的弊端

*缺点*

- 释放的地址不连续，空间碎片化
- 不会立即回收垃圾对象

##### 标记整理算法原理

- 可以看做是标记清除的增强
- 标记阶段的操作和标记清除一致
- 清除阶段会先执行整理，移动对象位置

---

#### V8引擎

##### 介绍

- V8是一款主流的Javascript执行引擎
- V8采用即时编译
- V8内存设限

##### V8垃圾回收策略

- 采用分代回收的思想
- 内存分为新生代、老生代（包含闭包）
- 针对不同对象采用不同算法

##### V8中常用的GC算法

- 分代回收
- 空间复制
- 标记清除
- 标记整理
- 标记增量

##### V8如何回收新生代对象

- V8内存空间一分为二
- 小空间用于存储新生代对象（32M|16M）
- 新生代指的是存活时间较短的对象
- 回收实现
  - 回收过程采用复制算法+标记整理
  - 新生代内存区分为二个等大小空间
  - 使用空间为From，空闲空间为To
  - 活动对象存储于From空间
  - 标记整理后将活动对象拷贝至To
  - From与To交换空间完成释放
- 回收细节说明
  - 拷贝过程中可能出现晋升
    - 晋升就是将新生代对象移动至老生代
    - 一轮GC还存活的新生代需要晋升
    - To空间的使用率超过25%

##### V8如何回收老生代对象

- 说明
  - 老生代对象存放在右侧老生代区域
  - 64位操作系统1.4G，32位操作系统700M
  - 老生代对象就是指存活时间较长的对象
- 回收实现
  - 主要采用标记清除、标记整理、增量标记算法
  - 首先使用标记清除完成垃圾空间的回收
  - 采用标记整理进行空间优化
  - 采用增量标记进行效率优化
- 与新生代细节对比
  - 新生代区域垃圾回收使用空间换时间
  - 老生代区域垃圾回收不适合复制算法： 空间太大、 消耗时间多

---

#### Performance工具

##### 为什么使用Performance

- GC的目的是为了实现内存空间的良性循环
- 良性循环的基石是合理使用
- 时刻关注才能确定是否合理
- Performance提供多种监控工具

##### 使用步骤

- 浏览器输入目标网址
- 打开开发人员工具，选择Performance（性能）
- 开启录制功能，访问具体界面
- 执行用户行为，一段时间后停止录制
- 分析界面中记录的内存信息

##### 内存问题的体现

###### 外在表现

- 页面出现延迟加载或经常性暂停
- 页面持续性出现糟糕的性能
- 页面的性能随时间延长越来越差

##### 监控内存的几种方式

###### 界定内存问题的标准

- 内存泄露： 内存使用持续升高
- 内存膨胀：在多数设备上都存在性能问题
- 频繁垃圾回收：通过内存变化图进行分析

###### 方式

- 浏览器任务管理器
- TImeline时序图记录
- 堆快照查找分离DOM
  - 堆快照留存JS堆照片
  - 分离DOM
    - 界面元素存活在DOM树上
    - 垃圾对象时的DOM节点
    - 分离状态的DOM节点
- 判断是否存在频繁的垃圾回收
  - GC工作时应用程序是停止的
  - 频繁过长的GC会导致应用假死
  - 用户使用中感知应用卡顿
  - 如何确定：
    - Timeline中频繁的上升下降
    - 任务管理器中数据频繁的增加减小

---

#### 代码优化介绍

- Javascript中的内存管理自动完成
- 执行引擎会使用不同的GC算法
- 算法工作的目的是为了实现内存空间良性循环
- Performance工具监测内存变化
- Javascript是单线程机制的解释型语言，尽量在代码过程中注意优化